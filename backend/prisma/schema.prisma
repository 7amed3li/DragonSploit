// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}


datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ========================================
// 1. Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
// ========================================
model RefreshToken {
  id          String   @id @default(cuid())
  hashedToken String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
} 

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  password    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  memberships Membership[] // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ø¶ÙˆÙ‹Ø§ ÙÙŠ Ø¹Ø¯Ø© Ù…Ø³Ø§Ø­Ø§Øª Ø¹Ù…Ù„
  invitations Invitation[] @relation("UserInvitations")
  auditLogs   AuditLog[]
  refreshTokens RefreshToken[]
  
  // ğŸ†• Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ù„ Ø§Ù„Ø«ØºØ±Ø©
  resolvedVulnerabilities Vulnerability[] @relation("ResolvedVulnerability")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // Ø±Ø§Ø¨Ø· ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ù†Ø¸Ù…Ø© Ù…Ø«Ù„ "my-company"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  scanConfigurations ScanConfiguration[]

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  members     Membership[]
  invitations Invitation[]
  targets     Target[]
  reports     Report[]
  apiTokens ApiToken[]
  auditLogs AuditLog[]
  scans       Scan[]
}

model Membership {
  id             String   @id @default(cuid())
  role           Role     @default(MEMBER)
  createdAt      DateTime @default(now())

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@unique([userId, organizationId]) // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ù…Ø±ØªÙŠÙ†
}

model Invitation {
  id             String           @id @default(cuid())
  email          String
  role           Role             @default(MEMBER)
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime         @default(now())

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  invitedBy      User           @relation("UserInvitations", fields: [invitedById], references: [id])
  invitedById    String
  
  @@unique([email, organizationId]) // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¯Ø¹ÙˆØ© Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø±ØªÙŠÙ† Ù„Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
}

// ========================================
// 2. Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ÙØ­Øµ
// ========================================

model Target {
  id           String   @id @default(cuid())
  url          String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  scans          Scan[]
  
  @@unique([url, organizationId]) // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³ Ø§Ù„Ù‡Ø¯Ù Ù…Ø±ØªÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
  @@index([organizationId, name]) // ğŸ†• ÙÙ‡Ø±Ø³ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
}

model Scan {
  id          String     @id @default(cuid())
  status      ScanStatus @default(PENDING)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  
  // technologyFingerprint Json? // âŒ ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±
  technologyFingerprint String? @db.Text // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØ®Ø²ÙŠÙ†Ù‡ ÙƒÙ†Øµ ÙˆØ§Ø¶Ø­ Ù„Ø¯Ø¹Ù… AI Context
  
  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  target             Target             @relation(fields: [targetId], references: [id], onDelete: Cascade)
  targetId           String
  
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId     String
  vulnerabilities    Vulnerability[]
  report             Report?            // Ø§Ù„ÙØ­Øµ Ø§Ù„ÙˆØ§Ø­Ø¯ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ù‡ ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ø­Ø¯
  configuration      ScanConfiguration? @relation(fields: [configurationId], references: [id])
  configurationId    String?

  @@index([organizationId, status]) // ğŸ†• ÙÙ‡Ø±Ø³ Ù„ØªØ­Ø³ÙŠÙ† ØªØµÙÙŠØ© Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
}

model Vulnerability {
  id             String            @id @default(cuid())
  // type           String            // âŒ ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ±
  type           VulnerabilityType // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ¹Ø¯Ø§Ø¯ Ù„Ù†ÙˆØ¹ Ø§Ù„Ø«ØºØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  severity       Severity          @default(MEDIUM)
  description    String            @db.Text
  proof          String            @db.Text // Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø«Ø¨Ø§Øª (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø·ÙˆÙŠÙ„Ø§Ù‹)
  isResolved     Boolean           @default(false)
  foundAt        DateTime          @default(now())
  resolvedAt     DateTime?         // ğŸ†• Ù…ØªÙ‰ ØªÙ… Ø§Ù„Ø­Ù„
  resolvedByUserId String?         // ğŸ†• Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø­Ù„

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  scan             Scan              @relation(fields: [scanId], references: [id], onDelete: Cascade)
  scanId           String
  
  // ğŸ†• Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø§Ù„Ø­Ù„
  resolvedByUser   User?             @relation("ResolvedVulnerability", fields: [resolvedByUserId], references: [id])
  
  @@index([scanId, severity]) // ğŸ†• ÙÙ‡Ø±Ø³ Ù„ØªØ­Ø³ÙŠÙ† ÙÙ„ØªØ±Ø© Ø§Ù„Ø«ØºØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ø®Ø·ÙˆØ±Ø©
}

model ScanConfiguration {
  id                 String  @id @default(cuid())
  name               String  // "Full Scan", "Quick XSS Check"
  isDiscoveryFocused Boolean @default(true)
  isAiPowered        Boolean @default(true)
  
  scans Scan[]
  
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
}

// ========================================
// 3. Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„
// ========================================

model Report {
  id             String   @id @default(cuid())
  format         String   // "PDF", "JSON", "HTML"
  storagePath    String   // Ù…Ø³Ø§Ø± ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„Ù (Ù…Ø«Ù„ S3 URL)
  createdAt      DateTime @default(now())

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  scan             Scan           @relation(fields: [scanId], references: [id])
  scanId           String         @unique // ÙƒÙ„ ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨ÙØ­Øµ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
}

model ApiToken {
  id             String   @id @default(cuid())
  name           String
  token          String   @unique // Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ù…Ø´ÙØ±
  permissions    String[] // ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙˆÙƒÙ†
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
}

// ========================================
// 4. Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚
// ========================================

model AuditLog {
  id             String   @id @default(cuid())
  action         String   // Ù…Ø«Ù„ "user.login", "target.create"
  details        Json     // ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ÙƒÙ€ JSON
  ipAddress      String?
  createdAt      DateTime @default(now())

  // --- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ---
  user             User           @relation(fields: [userId], references: [id])
  userId           String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  @@index([organizationId, createdAt(sort: Desc)]) // ğŸ†• ÙÙ‡Ø±Ø³ Ù„ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
}


// ========================================
// Ø§Ù„ØªØ¹Ø¯Ø§Ø¯Ø§Øª (Enums)
// ========================================

enum Role {
  ADMIN
  MEMBER
  BILLING_MANAGER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum ScanStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELED
}

enum Severity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ğŸ†• Ø§Ù„ØªØ¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø«ØºØ±Ø§Øª
enum VulnerabilityType {
  SQL_INJECTION
  CROSS_SITE_SCRIPTING
  RCE
  INFO_DISCLOSURE
  OTHER
}